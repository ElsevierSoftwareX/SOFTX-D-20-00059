<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.8.4" />
<title>demo_01_basics API documentation</title>
<meta name="description" content="For the documentation of this demo, see demo_01_basics.md …" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>demo_01_basics</code></h1>
</header>
<section id="section-intro">
<p>For the documentation of this demo, see demo_01_basics.md</p>
<h1 id="demo-01-basics">Demo 01 : Basics</h1>
<p>In this demo we investigate the basics of cashocs for
optimal control problems. To do so, we investigate the "mother
problem" of PDE constrained optimization, i.e.,</p>
<p><img src=
"https://render.githubusercontent.com/render/math?math=%5Cdisplaystyle+%5Cmin%5C%3B+J%28y%2Cu%29+%3D+%5Cfrac%7B1%7D%7B2%7D+%5Cint_%7B%5COmega%7D+%5Cleft%28+y+-+y_d+%5Cright%29%5E2+%5Ctext%7Bd%7Dx+%2B+%5Cfrac%7B%5Calpha%7D%7B2%7D+%5Cint_%7B%5COmega%7D+u%5E2+%5Ctext%7Bd%7Dx"
alt="\min\; J(y,u) = \frac{1}{2} \int_{\Omega} \left( y - y_d \right)^2 \text{d}x + \frac{\alpha}{2} \int_{\Omega} u^2 \text{d}x"></p>
<p>subject to <img src=
"https://render.githubusercontent.com/render/math?math=%5Cdisplaystyle+%5Cbegin%7Balign%2A%7D%0A-%5CDelta+y+%26%3D+u+%5Cquad+%5Ctext%7B+in+%7D%5C%3B+%5COmega%2C%5C%5C%0Ay+%26%3D+0+%5Cquad+%5Ctext%7B+on+%7D%5C%3B+%5CGamma%0A%5Cend%7Balign%2A%7D%0A"
alt="\begin{align*}
-\Delta y &= u \quad \text{ in }\; \Omega,\\
y &= 0 \quad \text{ on }\; \Gamma
\end{align*}
"></p>
<p>(see, e.g., <a href="https://doi.org/10.1090/gsm/112">Tröltzsch, Optimal Control of Partial Differential Equations</a>,
or <a href="https://doi.org/10.1007/978-1-4020-8839-1">Hinze et al., Optimization with PDE constraints</a>).</p>
<p>For this first example, we do not consider control constraints,
but search for an optimal control u in the entire space
<img src=
"https://render.githubusercontent.com/render/math?math=%5Ctextstyle+L%5E2%28%5COmega%29"
alt="L^2(\Omega)">, for the sake of simplicitiy. For
the domain under consideration, we use the unit square
<img src=
"https://render.githubusercontent.com/render/math?math=%5Ctextstyle+%5COmega+%3D+%280%2C+1%29+%5Ctimes+%280%2C1%29"
alt="\Omega = (0, 1) \times (0,1)">, since this is built into cashocs.</p>
<p>In the following, we will describe how to solve this problem
using cashocs, using as much of the package as possible. Moreover,
we also detail alternative / equivalent FEniCS code which could
be used to define the problem instead.</p>
<h2 id="the-initialization">The Initialization</h2>
<p>We begin by importing fenics and cashocs. For the sake of
better readability we import everyting from the fenics package.</p>
<pre><code>from fenics import *
import cashocs
</code></pre>
<p>Next, we have to load the config file which loads the user's
input parameters into the script. For a detailed documentation
of the config files and the parameters within, we refer to
the file "config_doc.md". The config is then loaded via</p>
<pre><code>config = cashocs.create_config('./config.ini')
</code></pre>
<blockquote>
<p>An alternative way of loading the config file (usually found
in previous iterations of the software) would be to load
the config file manually, via</p>
<pre><code>import configparser
config = configparser.ConfigParser()
config.read('path_to_config_file')
</code></pre>
<p>which is equivalent for optimal control problems, but does
not work for shape optimization problems. Hence, the former
method is to be preferred.</p>
</blockquote>
<p>Next up, we have to define the state equation. This mostly
works with usual fenics syntax. In cashocs, we can quickly
generate meshes for squares and cubes, as well as import
meshes generated by gmsh, for more complex geometries. In this
example we take a built-in unit square as example. This is generated
via</p>
<pre><code>mesh, subdomains, boundaries, dx, ds, dS = cashocs.regular_mesh(50)
</code></pre>
<p>The input for regular_mesh determines the number of elements that
are placed along each axis of the square. Note, that the mesh could be
further manipulated with additional, optional arguments, and we
refer to the documentation of <code>regular_mesh</code> for more infos. Note,
that the <code>subdomains</code> object is a (empty) MeshFunction, and that
<code>boundaries</code> is MeshFunction that contains markers for the following
boundaries
- The left side of the square is marked by 1
- The right side is marked by 2
- The bottom is marked by 3
- The top is marked by 4</p>
<p>Again, we refer the reader to the documentation of regular_mesh
for the marking conventions.</p>
<p>With the geometry defined, we create a function space with the classical
fenics syntax</p>
<pre><code>V = FunctionSpace(mesh, 'CG', 1)
</code></pre>
<p>which creates a function space of continuous, linear Lagrange
elements.</p>
<h2 id="definition-of-the-state-equation">Definition Of The State Equation</h2>
<p>To describe the state system in cashocs, we use nearly standard
fenics syntax, and the differences will be highlighted in the
following. First, we define a Function <code>y</code> that models our
state variable y, and a Function <code>p</code> that models the corresponding
adjoint variable p via</p>
<pre><code>y = Function(V)
p = Function(V)
</code></pre>
<p>Next up, we analogously define the control variable as Function <code>u</code></p>
<pre><code>u = Function(V)
</code></pre>
<p>This enables us to define the weak form of the state equation,
which is tested not with a TestFunction but with the adjoint
variable via the classical fenics / UFL syntax</p>
<pre><code>e = inner(grad(y), grad(p))*dx - u*p*dx
</code></pre>
<blockquote>
<p>For the clasical definition of this weak form with fenics
one would do the following</p>
<pre><code>y = TrialFunction(V)
p = TestFunction(V)
u = Function(V)
a = inner(grad(y), grad(p))*dx
L = u*p*dx
</code></pre>
<p>as this is a linear problem. However, to have greater flexibility
we have to treat the problems as being potentially nonlinear.
In this case, the classical fenics formulation for this as
nonlinear problem would be</p>
<pre><code>y = Function(V)
p = TestFunction(V)
u = Function(V)
F = inner(grad(y), grad(p))*dx -u*p*dx
</code></pre>
<p>which could then be solved via the "solve" interface. The
weak formulation we consider above mimics this nonlinear
formulation, which comes more naturally for nonlinear
variational problems (see the fenics examples). However,
for the use with cashocs, the state variable y <strong>must not</strong>
be a TrialFunction, and the adjoint variable p <strong>must not</strong>
be a TestFunction. They <strong>have to</strong> be defined as regular
Functions, otherwise the code will not work properly.</p>
</blockquote>
<p>After defining the weak form of the state equation, we now
specify the corresponding (homogeneous) Dirichlet boundary
conditions via</p>
<pre><code>bcs = cashocs.create_bcs_list(V, Constant(0), boundaries, [1,2,3,4])
</code></pre>
<p>This creates Dirichlet boundary conditions with value 0 at the
boundaries 1,2,3, and 4, i.e., everywhere.</p>
<blockquote>
<p>Classically, these boundary conditions could also be defined
via</p>
<pre><code>def boundary(x, on_bdry):
    return on_boundary
bc = DirichletBC(V, Constant(0), boundary)
</code></pre>
<p>which would yield a single DirichletBC object, instead of
the list returned by <code>create_bcs_list</code>. Any of the many methods for
defining the boundary conditions works here, as long as it
is valid input for the fenics' solve function.</p>
</blockquote>
<p>With the above description, we see that defining the state system
for cashocs is nearly identical to defining it with fenics,
the only major difference lies in the definition of the state
and adjoint variables as Function objects, instead of Trial- and
TestFunctions.</p>
<h2 id="definition-of-the-cost-functional">Definition Of The Cost Functional</h2>
<p>Now, we have to define the optimal control problem which we do
by first specifying the cost functional. To do so, we define the
desired state y<sub>d</sub> as an UFL expression <code>y_d</code>, i.e.,</p>
<pre><code>y_d = Expression('sin(2*pi*x[0])*sin(2*pi*x[1])', degree=1)
</code></pre>
<p>Alternatively, <code>y_d</code> could also be a function or any other object
that is usable in an UFL form (e.g. generate with SpatialCoordinate).</p>
<p>Then, we define the regularization parameter alpha and the tracking-type
cost functional via the commands</p>
<pre><code>alpha = 1e-6
J = Constant(0.5)*(y - y_d)*(y - y_d)*dx + Constant(0.5*alpha)*u*u*dx
</code></pre>
<p>The cost functional has to be a UFL form, which returns the
value when evaluated with the assemble command from fenics.
These definitions are also classical in the sense that they
would have to be performed in this (or a similar) way in fenics
when one would want to evaluate the (reduced) cost functional,
so that we have only very little overhead.</p>
<h2 id="definition-of-the-optimization-problem-and-its-solution">Definition Of The Optimization Problem And Its Solution</h2>
<p>Finally, we set up an optimal control problem <code>ocp</code> and then
directly solve it via cashocs with the commands</p>
<pre><code>ocp = cashocs.OptimalControlProblem(e, bcs, J, y, u, p, config)
ocp.solve()
</code></pre>
<p>Note, that the <code>solve</code> command without any additional keyword arguments leads to
cashocs using the settings defined in the config file. However, there are some options
that can be directly set with keyword arguments for the <code>solve</code> call. These are</p>
<ul>
<li><code>algorithm</code> : Specifies which solution algorithm shall be used.</li>
<li><code>rtol</code> : The relative tolerance for the optimization algorithm.</li>
<li><code>atol</code> : The absolute tolerance for the optimization algorithm.</li>
<li><code>max_iter</code> : The maximum amount of iterations that can be carried out.</li>
</ul>
<p>The possible values for these are the same as the corresponding ones in the config file.
This just allows for some shortcuts, e.g., when one wants to quickly use a different solver.</p>
<p>This concludes the demo, and the corresponding full code can
be found in the file "demo_01.py".</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python"># Copyright (C) 2020 Sebastian Blauth
#
# This file is part of CASHOCS.
#
# CASHOCS is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# CASHOCS is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with CASHOCS.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

&#34;&#34;&#34;For the documentation of this demo, see demo_01_basics.md

.. include:: ./demo_01_basics.md

&#34;&#34;&#34;

from fenics import *
import cashocs



config = cashocs.create_config(&#39;config.ini&#39;)
mesh, subdomains, boundaries, dx, ds, dS = cashocs.regular_mesh(25)
V = FunctionSpace(mesh, &#39;CG&#39;, 1)

y = Function(V)
p = Function(V)
u = Function(V)

e = inner(grad(y), grad(p))*dx - u*p*dx

bcs = cashocs.create_bcs_list(V, Constant(0), boundaries, [1, 2, 3, 4])

y_d = Expression(&#39;sin(2*pi*x[0])*sin(2*pi*x[1])&#39;, degree=1)
alpha = 1e-6
J = Constant(0.5)*(y - y_d)*(y - y_d)*dx + Constant(0.5*alpha)*u*u*dx

ocp = cashocs.OptimalControlProblem(e, bcs, J, y, u, p, config)
ocp.solve()</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul>
<li><a href="#demo-01-basics">Demo 01 : Basics</a><ul>
<li><a href="#the-initialization">The initialization</a></li>
<li><a href="#definition-of-the-state-equation">Definition of the state equation</a></li>
<li><a href="#definition-of-the-cost-functional">Definition of the cost functional</a></li>
<li><a href="#definition-of-the-optimization-problem-and-its-solution">Definition of the optimization problem and its solution</a></li>
</ul>
</li>
</ul>
</div>
<ul id="index">
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.8.4</a>.</p>
</footer>
</body>
</html>